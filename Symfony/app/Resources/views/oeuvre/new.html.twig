{% extends ':layout:layout.html.twig' %}

{% block body %}

    {{ form_start(form) }}
    <div class="panel panel-default">
        <div class="panel-heading">
            Création d'une nouvelle oeuvre
        </div>
        <div id="contnewOeuv" class="container">
            {# Selection de l'artiste et Etat de l'oeuvre #}
            <div class="row">
                <div class="col-md-7">
                    <div class="col-md-1 form-group">
                        {# Génération du label #}
                        {{ form_label(form.nom, "Nom", {'label_attr': {'class': 'control-label ajust'}})}}
                    </div>
                    <div class="col-md-5 form-group">
                        {# Génération de l'input #}
                        {{ form_widget(form.nom, {'attr': {'class': 'form-control ajust'}}) }}
                    </div>
                    <div class="col-md-2 form-group">
                        <label for="Art" class="control-label ajust">Artiste</label>
                    </div>
                    <div class="col-md-4 form-group">
                        {# Génération de l'input #}
                        {{ form_widget(form.artiste, {'attr': {'class': 'col-md-2 form-control ajust'}}) }}
                    </div>
                    <div id="addmulti" class="form-group">
                        <div class="col-md-4 labelmulti"></div>
                        <div class="col-md-6 champsmulti"></div>
                        <div class="col-md-1 deplacemulti"></div>   
                    </div>
                </div>
                <div class="col-md-2">
                    {{ form_label(form.etat)}}
                    {{ form_widget(form.etat)}}
                </div>
                <div id="previsu" class="col-md-2">
                {% image 'image/specimen.png' %}
                    <img class="specimen img-responsive" title="Image Oeuvre" src="{{ asset_url }}" width="141px" height="141px"/>
                {% endimage %}
                </div>
                <div id="adddes" class="col-md-12">
                        <div class="col-md-1 fixlabel labeldes"></div>
                        <div class="col-md-3 champsdes"></div>
                    <div class="fixlang">
                        <div class="col-md-1 labellang"></div>
                        <div class="col-md-2 champslang"></div>
                        <div class="col-md-1 deplace"></div>
                    </div>        
                </div>
                <div id="newoeuvfond" class="col-md-12">
                    <div class="col-md-4">
                        <label for="Art" class="control-label ajust">Générer un FlashCode</label>
                        {# Génération de l'input #}
                        {{ form_widget(form.genFlashcode, {'attr': {'class': 'ajustgenFlash'}}) }}
                    </div>
                    <div class="col-md-4">
                        <input id="newartval" type="submit" value="Enregistrer" />
                        <a id="newartret" href="{{ path('oeuvre_index') }}">Retour à la liste</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {{ form_end(form) }}
{% endblock %}
{% block javascripts %}
    <script type="text/javascript">

    $(document).ready(function(){

        // On ajoute le choix d'un nouvel artiste
        $('#oeuvre_artiste').append('<option id="newart" value="new">Nouvel artiste</option>');
        // Quand on clique sur le choix précédent on est redirigé vers le formulaire
        $('#oeuvre_artiste').attr('onclick','myFunction()');

        //On récupére la balise <div> en question qui contient l'attribut "data-prototype" qui nous intéresse.
        var $container = $('div#oeuvre_texteoeuvres');

        $('#adddes').append($container);
        
        //On ajoute un lien pour ajouter un nouveau textexposition
        var $addLink =$('<a type="button" id="add_textoeuvre" class="glyphicon glyphicon-plus vert"></a>');
        $container.append($addLink);

        //On ajoute un nouveau champs à chaque clic sur le lien d'ajout.
        $addLink.click(function(e) {
            addTexteOeuvre($container);
            e.preventDefault(); // évite qu'un # apparaisse dans l'url
            return false;
        });

        //On définit un compteur unique pour nommer les champs qu'on va ajouter dynamiquement 
        var index = $container.find(':input').length;
       
        //On ajoute un premier champ automatiquement s'il n'en existe pas déjà un (cas d'une nouvelle exposition par exemple).
        if (index==0) {
            addTexteOeuvre($container);
        } else {
            //Pour chaque catégorie déjà existante, on ajoute un lien de suppression
            $container.children('div').each(function () {
                addDeleteLink($(this));
            });
        }

        //La function qui ajoute un formulaire textexposition
        function addTexteOeuvre($Container) {
            // Dans le contenu de l'attribut "Data-prototype", on remplace

            // le texte "__name__label__" qu'il contient par le label du champ

            // le texte "__name__" qu'il contient par le numro du champ
            var $prototype = $($container.attr('data-prototype').replace(/__name__label_/g, 'Texte n°' + (index+1)).replace(/__name__/g, index));

            $newprototype = $($prototype);

            var descendant = $newprototype.find('*');

            
            // Puis on les accompagne une par une dans les balises div mises en forme pour l'affichage
            $('.labeldes').append(descendant[3]);
            $('.champsdes').append(descendant[4]);
            $('.labellang').append(descendant[6]);
            $('.champslang').append(descendant[7]);

            // On ajoute au prototype un lien pour pouvoir supprimer le telephone
            addDeleteLink($('.deplace'));

            //enfin, on incrémente le compteur pour que le prochain ajout se fasse avec un autre numéro
            index++;
        }
        //la fonction qui ajoute un lien de suppression d'un text
        function addDeleteLink($prototype) {
            //création du lien 
            $deleteLink = $('<a type="button" name="'+index+'" class="glyphicon glyphicon-minus red"></a>');

            //Ajout du lien
            $prototype.append($deleteLink);

            //Ajout du listener sur le clic du lien
            $deleteLink.click(function(e) {

                // On récupère l'index du champs à supprimer
                var num = $(this).attr('name');
                // On supprime les champs un à un
                // Label descript
                $('[for="oeuvre_texteoeuvres_'+num+'_description"]').remove();
                // Champs descript
                $('[id="oeuvre_texteoeuvres_'+num+'_description"]').remove();
                 // Label langue
                $('[for="oeuvre_texteoeuvres_'+num+'_langue"]').remove();
                // Champs langue
                $('[id="oeuvre_texteoeuvres_'+num+'_langue"]').remove();
                $(this).remove();
                
                e.preventDefault(); // Evite qu'un # apparaisse dans l'URL
                index--;
                return false;
            });
        }
/****************************************************************************************************/
        //On récupére la balise <div> en question qui contient l'attribut "data-prototype" qui nous intéresse.
        var $container2 = $('div#oeuvre_multimedias');

        $('#addmulti').append($container2);

        //On ajoute un lien pour ajouter un nouveau lien
        var $addLink2 =$('<a type="button" id="add_multimedia" title="Ajouter un nouveau lien" class="glyphicon glyphicon-retweet vert2"></a>');
        $container2.append($addLink2);

        //On ajoute un nouveau champs à chaque clic sur le lien d'ajout.
        $addLink2.click(function(e) {
            addLienMulti($container2);
            e.preventDefault(); // évite qu'un # apparaisse dans l'url
            return false;
        });

        //On définit un compteur unique pour nommer les champs qu'on va ajouter dynamiquement 
        var index2 = $container2.find(':input').length;
       
        //On ajoute un premier champ automatiquement s'il n'en existe pas déjà un (cas d'une nouvelle exposition par exemple).
        if (index2==0) {
            addLienMulti($container2);
        } else {
            //Pour chaque catégorie déjà existante, on ajoute un lien de suppression
            $container2.children('div').each(function () {
                addDeleteLienMulti($(this));
            });
        }

        //La function qui ajoute un formulaire de lien
        function addLienMulti($Container) {
            // Dans le contenu de l'attribut "Data-prototype", on remplace

            // le texte "__name__label__" qu'il contient par le label du champ

            // le texte "__name__" qu'il contient par le numro du champ
            var $prototype2 = $($container2.attr('data-prototype').replace(/__name__label_/g, 'Lien n°' + (index2+1)).replace(/__name__/g, index2));

            $newprototype2 = $($prototype2);

            var descendant2 = $newprototype2.find('*');

            // Puis on les accompagne une par une dans les balises div mises en forme pour l'affichage
            $('.labelmulti').append(descendant2[3]);
            $('.champsmulti').append(descendant2[2]);

            // Label lien
            $('[for="oeuvre_multimedias_'+index2+'_lien"]').attr('class','control-label ajust multi');
            // Champs lien
            $('[id="oeuvre_multimedias_'+index2+'_lien"]').attr('class','form-control ajust linkshow');

            // Quand on colle un lien dans le champs on affiche sa miniature
            $('.linkshow').attr('onchange','myImageFunction(this)');

            // On ajoute au prototype un lien pour pouvoir supprimer le lien
            addDeleteLienMulti($('.deplacemulti'));

            //enfin, on incrémente le compteur pour que le prochain ajout se fasse avec un autre numéro
            index2++;
        }
        //la fonction qui ajoute un lien de suppression d'un text
        function addDeleteLienMulti($prototype2) {
            //création du lien 
            $deleteLink2 = $('<a type="button" title="Supprimer le lien" name="'+index2+'" class="glyphicon glyphicon-scissors red2"></a>');

            //Ajout du lien
            $prototype2.append($deleteLink2);

            //Ajout du listener sur le clic du lien
            $deleteLink2.click(function(e) {

                // On récupère l'index du champs à supprimer
                var num2 = $(this).attr('name');
                // On supprime les champs un à un
                 // Label lien
                $('[for="oeuvre_multimedias_'+num2+'_lien"]').remove();
                // Champs lien
                $('[id="oeuvre_multimedias_'+num2+'_lien"]').remove();
                $(this).remove();
                
                e.preventDefault(); // Evite qu'un # apparaisse dans l'URL
                index2--;
                return false;
            });
        }
    });

    // Fonction afin de rediriger sur la page new artist
    function myFunction() {

        if($('#oeuvre_artiste').val() == "new"){
            document.location.href="{{ path('artiste_new') }}";
        }
    }
    
    // Fonction pour afficher une miniature du lien
    function myImageFunction(valeur) {
        // On récupère la valeur à partir de l'id du champs sélectionné
        var val = $("#"+valeur.id).val();
        // On retire l'image par défaut
        $('.specimen').remove();
        // On créé une nouvelle image
        $img = document.createElement('img');
        $img.setAttribute('class','specimen img-responsive');
        $img.src = "http://www.robothumb.com/src/?url="+val+"&size=560x420.png";
        $('#previsu').append($img);
        
    }
    
    </script>
{% endblock %}